<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bodegas Fuentesnuevas - V7.1 Empate</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root { --vino: #b30000; --oro: #FFFF00; --fondo: #121212; --tecla: #eeeeee; --verde: #28a745; --blanco: #ffffff; }
        body { background: var(--fondo); color: white; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 10px; user-select: none; }
        .container { width: 100%; max-width: 400px; margin: auto; text-align: center; }
        
        header { display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid var(--vino); padding-bottom: 10px; margin-bottom: 15px; }
        h1 { color: var(--oro); font-size: 0.9rem; margin: 0; text-transform: uppercase; }
        #btn-salir-head { background: #444; color: white; border: none; padding: 8px 15px; border-radius: 5px; font-weight: bold; cursor: pointer; font-size: 0.8rem; }

        .card { background: #1e1e1e; border: 1px solid #333; border-radius: 8px; padding: 12px; margin-bottom: 10px; position: relative; text-align: left; }
        .bodega-nom { color: var(--oro); font-weight: bold; text-transform: uppercase; display: block; margin-bottom: 10px; font-size: 1.1rem; }
        
        .pts-vivos { 
            position: absolute; top: 10px; right: 10px; 
            background: rgba(255, 255, 255, 0.1); 
            padding: 4px 10px; border-radius: 20px;
            color: var(--oro); font-weight: 900; font-size: 0.9rem; 
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; }
        .btn-p { background: var(--tecla); color: black; border: none; padding: 15px 0; border-radius: 4px; font-weight: bold; font-size: 1.1rem; cursor: pointer; }
        .btn-p.sel { background: var(--vino) !important; color: white !important; box-shadow: 0 0 10px var(--oro); transform: scale(1.05); }

        #btn-enviar { width: 100%; padding: 20px; border-radius: 12px; font-size: 1.3rem; font-weight: 900; margin: 15px 0; background: var(--verde); color: white; border: none; cursor: pointer; }
        #btn-enviar:disabled { background: #444; color: #888; cursor: not-allowed; }

        /* MODALES */
        .modal { display: none; background: white; color: #222; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 380px; padding: 20px; border-radius: 15px; box-shadow: 0 0 50px rgba(0,0,0,0.8); z-index: 1000; }
        .input-pass { width: 100%; padding: 15px; font-size: 1.5rem; text-align: center; border: 2px solid #ccc; border-radius: 8px; margin-bottom: 10px; box-sizing: border-box; }
        .btn-admin { width: 100%; padding: 15px; margin: 5px 0; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; text-transform: uppercase; }
        .fila-puntos { display: flex; justify-content: space-between; padding: 10px 5px; border-bottom: 1px solid #eee; font-size: 1.1rem; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>BODEGAS FUENTESNUEVAS</h1>
        <button id="btn-salir-head" onclick="salirApp()">SALIR</button>
    </header>

    <div id="lista-bodegas"></div>
    
    <button id="btn-enviar" onclick="enviarVoto()" disabled>CONECTANDO...</button>
    <div id="info-votos" style="font-size: 0.9rem; color: #aaa; margin-top: -10px; margin-bottom: 15px; font-weight: bold;"></div>

    <div id="modal-login" class="modal">
        <h3 style="text-align:center; margin-top:0;">ADMINISTRACI√ìN</h3>
        <input type="password" id="pass-admin" class="input-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" inputmode="numeric">
        <button class="btn-admin" style="background:var(--vino); color:white;" onclick="entrarAdmin()">ENTRAR</button>
        <button class="btn-admin" style="background:#eee;" onclick="cerrarModales()">CANCELAR</button>
    </div>

    <div id="modal-opciones" class="modal">
        <h3 style="text-align:center; margin-top:0;">OPCIONES ADMIN</h3>
        <button class="btn-admin" style="background:#007bff; color:white;" onclick="verActa()">VER RESULTADOS (ACTA)</button>
        <button class="btn-admin" style="background:#dc3545; color:white;" onclick="resetVotacion()">REINICIAR TODO</button>
        <button class="btn-admin" style="background:#eee;" onclick="cerrarModales()">CERRAR</button>
    </div>

    <div id="modal-acta" class="modal">
        <h3 style="text-align:center; margin-top:0;">ACTA DE RESULTADOS</h3>
        <div id="acta-cuerpo"></div>
        <div id="acta-ganador" style="background:#fff9c4; padding:15px; text-align:center; font-weight:bold; margin-top:15px; border-radius:8px; border: 2px solid var(--oro); line-height: 1.4;"></div>
        <button class="btn-admin" style="background:#222; color:white; margin-top:15px;" onclick="cerrarModales()">CERRAR</button>
    </div>

    <div style="margin-top:40px; opacity:0.1; cursor:pointer; padding:20px; font-size: 0.7rem;" onclick="abrirLogin()">acceso administraci√≥n</div>
</div>

<script>
    const firebaseConfig = { databaseURL: "https://proyec-bodegasfuentesnuevas-default-rtdb.firebaseio.com/" };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const IDS = ["vale", "isa", "moran", "carreira", "alvarez"];
    const NOMS = ["VALE", "ISA", "MOR√ÅN", "CARREIRA", "√ÅLVAREZ"];
    let misVotos = { vale:0, isa:0, moran:0, carreira:0, alvarez:0 };
    let nube = {vale:0, isa:0, moran:0, carreira:0, alvarez:0};

    db.ref('puntuacion').on('value', snap => {
        const data = snap.val();
        if(data) { nube = data; actualizarUI(); }
    });

    function init() {
        const cont = document.getElementById('lista-bodegas');
        cont.innerHTML = IDS.map((id, i) => `
            <div class="card" id="card-${id}">
                <span class="pts-vivos" id="live-${id}">0 Pts</span>
                <span class="bodega-nom">${NOMS[i]}</span>
                <div class="grid">${[1,2,3,4,5].map(v => `<button class="btn-p" id="b-${id}-${v}" onclick="clic('${id}',${v})">${v}</button>`).join('')}</div>
            </div>
        `).join('');
        actualizarUI();
    }

    function clic(id, pts) {
        if (getV() >= 5) return;
        if (misVotos[id] === pts) {
            misVotos[id] = 0;
        } else {
            IDS.forEach(key => { if(misVotos[key] === pts) misVotos[key] = 0; });
            misVotos[id] = pts;
        }
        IDS.forEach(bId => {
            document.querySelectorAll(`#card-${bId} .btn-p`).forEach(btn => {
                const val = parseInt(btn.innerText);
                btn.classList.remove('sel');
                if (val === misVotos[bId]) btn.classList.add('sel');
            });
        });
        actualizarUI();
    }

    function enviarVoto() {
        const n = getV();
        const algunVoto = Object.values(misVotos).some(v => v > 0);
        if (!algunVoto) return alert("Selecciona al menos una puntuaci√≥n.");

        const btn = document.getElementById('btn-enviar');
        btn.disabled = true;
        btn.innerText = "REGISTRANDO...";

        db.ref('puntuacion').transaction((current) => {
            if (current === null) return misVotos;
            let up = {...current};
            IDS.forEach(id => { up[id] = (up[id] || 0) + misVotos[id]; });
            return up;
        }, (error, committed) => {
            if (committed) {
                localStorage.setItem('votos_final_v5', n + 1);
                misVotos = { vale:0, isa:0, moran:0, carreira:0, alvarez:0 };
                alert("¬°Voto registrado!");
                location.reload(); 
            } else { alert("Error."); actualizarUI(); }
        });
    }

    function actualizarUI() {
        const n = getV();
        const btn = document.getElementById('btn-enviar');
        const info = document.getElementById('info-votos');
        if(info) info.innerText = n < 5 ? `TURNO ACTUAL: PARTICIPANTE ${n+1}` : "VOTACI√ìN FINALIZADA";
        IDS.forEach(id => {
            const el = document.getElementById('live-'+id);
            if(el) el.innerText = (nube[id] || 0) + " Pts";
        });
        if (btn) {
            if (n >= 5) { btn.innerText = "L√çMITE ALCANZADO"; btn.disabled = true; } 
            else {
                const algunVoto = Object.values(misVotos).some(v => v > 0);
                btn.innerText = algunVoto ? "ENVIAR MI VOTO" : "MARCA UN PUNTO";
                btn.disabled = !algunVoto;
            }
        }
    }

    function getV() { return parseInt(localStorage.getItem('votos_final_v5') || "0"); }
    function abrirLogin() { document.getElementById('modal-login').style.display = 'block'; }
    function cerrarModales() { document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); }
    
    function entrarAdmin() {
        if (document.getElementById('pass-admin').value === '55555') {
            cerrarModales();
            document.getElementById('modal-opciones').style.display = 'block';
        } else { alert("Error"); }
    }

    // L√ìGICA DE DETECCI√ìN DE EMPATES M√öLTIPLES
    function verActa() {
        cerrarModales();
        let h = "", max = -1, ganadores = [];
        
        // 1. Encontrar la puntuaci√≥n m√°xima
        IDS.forEach(id => { if (nube[id] > max) max = nube[id]; });

        // 2. Identificar qui√©nes tienen esa puntuaci√≥n (si es mayor a 0)
        IDS.forEach((id, i) => {
            const p = nube[id] || 0;
            if (p === max && max > 0) ganadores.push(NOMS[i]);
            h += `<div class="fila-puntos"><span>${NOMS[i]}</span><b>${p} Pts</b></div>`;
        });

        document.getElementById('acta-cuerpo').innerHTML = h;
        
        // 3. Mostrar mensaje personalizado seg√∫n si hay uno o varios ganadores
        const divG = document.getElementById('acta-ganador');
        if (max <= 0) {
            divG.innerHTML = "ESPERANDO VOTOS";
        } else if (ganadores.length > 1) {
            divG.innerHTML = `ü§ù EMPATE ENTRE:<br><span style="color:var(--vino); font-size:1.2rem;">${ganadores.join(" & ")}</span>`;
        } else {
            divG.innerHTML = `üèÜ GANADOR:<br><span style="color:var(--vino); font-size:1.2rem;">${ganadores[0]}</span>`;
        }
        
        document.getElementById('modal-acta').style.display = 'block';
    }

    function resetVotacion() {
        if (confirm("¬øBORRAR TODO?")) {
            db.ref('puntuacion').set({vale:0, isa:0, moran:0, carreira:0, alvarez:0}).then(() => {
                localStorage.clear();
                location.reload();
            });
        }
    }

    function salirApp() { if(confirm("¬øSalir?")) window.location.href = "https://www.google.com"; }
    window.onload = init;
</script>
</body>
</html>
